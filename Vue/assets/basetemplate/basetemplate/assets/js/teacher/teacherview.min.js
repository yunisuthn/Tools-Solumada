var coursNameTeacher=$("#courNameTeacher").text(),groupMemberList=[],groupMemberPresentList=[],groupMemberAbsentList=[],currentGroupName="",firstShow=!0;let teacherTimeTableDataTable;function refreshData(){setAddMemberList();var a=$("#teacherSelectGroup").val();if(a!=currentGroupName&& !0==firstShow){var b=`/groupemember/${coursNameTeacher}/${a}`;$("#GroupTeacherDatatable").DataTable({ajax:{url:`${b}`,dataSrc:""},columns:[{data:"_id",render:function(a){return`<input id="grpID" type="hidden" value=${a} />`}},{data:"username"},{data:"name"},{data:"mcode"},{data:"num_agent"},{data:"niveau",render:function(a){return a||""}},{defaultContent:"                                    <div class='btn-group d-flex justify-content-center' role='group' aria-label='Basic mixed styles example'>                                        <button type='button'  class='btn px-2 rounded mx-1 btn-sm btn-success addLevel' data-toggle='modal' data-target='#addLevel' data-bs-whatever='@getbootstrap'><i class='fa fa-plus'></i></button>                                        <button type='button'  class='btn px-2 rounded btn-sm btn-danger removeToGroup'><i class='fa fa-trash'></i></button>                                    </div>                                    "},],scrollX:!0}),currentGroupName=a,firstShow=!1}else if(a!=currentGroupName&& !1==firstShow){$("#table-container").empty();var c='<table id="GroupTeacherDatatable" name="table" class="table table-striped table-bordered"><thead><tr><th>Id</th><th>Username</th><th>Full Name</th><th>M Code</th><th>Numbering</th><th>Level</th><th class="text-center">Actions</th></tr></thead><tbody></tbody></table>';$("#table-container").append(c);var b=`/groupemember/${coursNameTeacher}/${a}`;$("#GroupTeacherDatatable").DataTable({ajax:{url:`${b}`,dataSrc:""},columns:[{data:"_id",render:function(a){return`<input id="grpID" type="hidden" value=${a} />`}},{data:"username"},{data:"name"},{data:"mcode"},{data:"num_agent"},{data:"niveau",render:function(a){return a||""}},{defaultContent:"                                    <div class='btn-group d-flex justify-content-center' role='group' aria-label='Basic mixed styles example'>                                        <button type='button'  class='btn px-2 btn-sm rounded mx-1 btn-success addLevel' class='btn btn-sm btn-success' data-toggle='modal' data-target='#addLevel' data-bs-whatever='@getbootstrap'><i class='fa fa-plus'></i></button>                                        <button type='button'  class='btn px-2 btn-sm rounded btn-danger removeToGroup'><i class='fa fa-trash'></i></button>                                    </div>                                    "},],scrollX:!0}),currentGroupName=a}else $("#GroupTeacherDatatable").DataTable().ajax.reload(null,!1)}function setAddMemberList(){$("#listUserC").empty();var a=$("#teacherSelectGroup").val();dataToSend={cours:coursNameTeacher,groupe:a},$.ajax({url:"/getMemberAndAllUserList",method:"post",dataType:"json",data:dataToSend,success:function(a){a.forEach(a=>{options=`<option value="${a.email}">${a.username}</option>`,$("#listUserToAddMember").append(options)}),$(".memberSelect").chosen({disable_search_threshold:10,no_results_text:"Oops, nothing found!",width:"100%"})},error:function(a){Swal.fire("Error","There is an error please try again later!","error",{confirmButtonText:"Ok"})}})}function resetTeacherAddMemberForm(){$(".closeAddMember").click(),$("#listUserToAddMember").prop("selected",!1)}function searchOnDatatable(a,b){currentPage=a.page(),a.search(b).draw()}function resetTimeTableForm(a){switch(a){case"add":$("#formAddTimeTable").each(function(){this.reset()}),$("#closetimeTableModal").click();break;case"update":$("#formUpdateTimeTable").each(function(){this.reset()}),$("#closetimeUpdateTableModal").click()}}$("#addMememberToGroupTeacher").on("click",function(){var a=$("#teacherSelectGroup").val();$(".teacherAddMemberLabel").html(a)}),$("#saveNewGroup").on("click",function(){var a=$("#newgroupName").val();$.ajax({url:"/addgroupe",method:"post",data:{newgroupe:a,cours:coursNameTeacher},success:function(b){Swal.fire("Group created",`Group ${a} saved successfuly`,"success",{confirmButtonText:"Ok"}),$("#teacherSelectGroup").append(`<option value="${a}">${a}</option>`),$("#cancelGroup").click(),$("#newgroupName").val("")},error:function(a){Swal.fire("Error",`Error occured when creating group ${$("#newgroupName").val()}`,"error",{confirmButtonText:"Ok"})}})}),$("#teacherSelectGroup").on("change",function(){$("#addMememberToGroupTeacher").css("display","block"),$("#addLevelToGroupTeacher").css("display","block"),refreshData()}),$("#saveNewMemberList").on("click",function(){var a=[];$("#listUserToAddMember").val().forEach(b=>a.push(b));var b={groupeName:$("#teacherSelectGroup").val(),coursName:coursNameTeacher,newMemberList:a};$.ajax({url:"/newmembreajax",method:"post",data:b,success:function(a){Swal.fire("Members Saved",`Members saved on group ${$("#teacherSelectGroup").val()}`,"success",{confirmButtonText:"Ok"}),refreshData(),resetTeacherAddMemberForm()},error:function(a){Swal.fire("Error",`Error occured when save member saved on group ${$("#teacherSelectGroup").val()}`,"error",{confirmButtonText:"Ok"})}})}),$(document).on("click",".addLevel",function(){var a=$(this).closest("tr"),b=a.find("td:eq(2)").text(),c=a.find("td:eq(0)").text();$(".userNameLevel").text(`Add Level to ${b}`),$("#labelCourLevel").text(`${coursNameTeacher} Level`),$("#idLevel").val(c)}),$("#saveLevel").on("click",function(){var a={id:$("#idLevel").val(),level:$("#coursLevel").val()};$.ajax({url:"/addLevelToMember",method:"post",data:a,success:function(a){Swal.fire("Level Saved","Level added successfuly!","success",{confirmButtonText:"Ok"}),$("#coursLevel").val(""),$("#cancelLevel").click(),$("#GroupTeacherDatatable").DataTable().ajax.reload(null,!1)},error:function(a){Swal.fire("Error","Error occured when adding level!","error",{confirmButtonText:"Ok"})}})}),$(document).on("click",".removeToGroup",function(){var a=$(this).closest("tr"),d=a.find("td:eq(0)").find("#grpID").val(),b=a.find("td:eq(2)").text(),c=$("#teacherSelectGroup").val();Swal.fire({title:"Remove Group Member",text:`Are you sure to remove ${b} from ${c} ?`,icon:"warning",showCancelButton:!0,confirmButtonColor:"red",cancelButtonColor:"green",confirmButtonText:"Yes, I'm sure!"}).then(a=>{a.isConfirmed&&$.ajax({url:"/deleteMb",method:"post",data:{id:d},success:function(a){refreshData(),resetTeacherAddMemberForm(),responsetxt=`Member ${b} removed from ${c} successfully`,Swal.fire({position:"center",icon:"success",title:responsetxt,showConfirmButton:!1,timer:1700})},error:function(a){Swal.fire({position:"top-center",icon:"error",title:"Error occured when perform this action please try again later!",showConfirmButton:!1,timer:1700})}})})}),teacherTimeTableDataTable=$("#teachertimeTable").DataTable({ajax:{url:`/teacherTimeTable/${coursNameTeacher}`,dataSrc:""},columns:[{data:"_id",render:function(a){return`<input id="timeID" type="hidden" value=${a} />`}},{data:"jours"},{data:"date",render:function(a){return a?new Date(a).toLocaleDateString("fr"):""}},{data:"groupe"},{data:"heureStart"},{data:"heureFin"},{defaultContent:`
                                <div class="btn-group d-flex justify-content-center" role="group" aria-label="Basic mixed styles example">
                                    <button class="btn rounded mx-1 px-2 btn-sm btn-warning rounded UpdateTeacherTimeTable" type="button"data-toggle="modal" data-target="#UpdatetimeTableModal"><i class="fa fa-edit"></i></button>
                                    <button type="button"  class="btn px-2 btn-sm rounded btn-danger deleteTimeTable"><i class="fa fa-trash"></i></button>
                                </div>
                                `}],scrollX:!0}),$("#saveTimeTable").on("click",function(){var a={jours:$("#select-jour").val(),groupe:$("#select-gpe").val(),timeStart:$("#timeStart").val(),timeEnd:$("#timeEnd").val(),date_time:$("#dateAddTimeTable").val(),cours:coursNameTeacher};$.ajax({url:"/EmplTemp",method:"post",data:a,success:function(a){"success"==a?(responsetxt="Time Table Saved successfully",Swal.fire("Success",responsetxt,"success",{confirmButtonText:"Ok"}),$("#teachertimeTable").DataTable().ajax.reload(null,!1),searchOnDatatable(teacherTimeTableDataTable,$("#select-gpe").val()),resetTimeTableForm(action="add")):Swal.fire("Error","Failed to save Time Table","error",{confirmButtonText:"Ok"})},error:function(a){Swal.fire("Error","Error please report this error!","error",{confirmButtonText:"Ok"})}})}),$(document).on("click",".UpdateTeacherTimeTable",function(){var a=$(this).closest("tr").find("td:eq(0)").find("#timeID").val();$.ajax({url:"/gettime",method:"post",data:{id:a},success:function(a){$("#id-timetable-update").val(a._id),$("#select-jour-update").val(a.jours),$("#timetablegroupupdate").val(a.groupe),$("#timeStart-update").val(a.heureStart),$("#timeEnd-update").val(a.heureFin);var b=new Date(a.date).toLocaleDateString("fr").split("/").reverse().join("-");$("#dateUpdateTimeTable").val(b)},error:function(a){Swal.fire({position:"top-center",icon:"error",title:"Error occured!",showConfirmButton:!1,timer:1700})}})}),$("#saveTeacherUpdateTimeTable").on("click",function(){var a={id:$("#id-timetable-update").val(),jours:$("#select-jour-update").val(),group:$("#select-groupe-update").val(),heurdebut:$("#timeStart-update").val(),heurfin:$("#timeEnd-update").val(),date:$("dateUpdateTimeTable").val()};$.ajax({url:"/update_time",method:"post",data:a,success:function(a){"success"===a?(Swal.fire({position:"top-center",icon:"success",title:"Time table updated successfuly!",showConfirmButton:!1,timer:1700}),$("#teachertimeTable").DataTable().ajax.reload(null,!1),searchOnDatatable(teacherTimeTableDataTable,$("#id-timetable-update").val()),resetTimeTableForm("update")):Swal.fire({position:"top-center",icon:"error",title:"Error occured!",showConfirmButton:!1,timer:1700})}})}),$(document).on("click",".deleteTimeTable",function(){var a=$(this).closest("tr").find("td:eq(0)").find("#timeID").val();$.ajax({url:"/gettime",method:"post",data:{id:a},success:function(a){Swal.fire({title:"Delete TimeTable",text:"Are you sure to delete this?",icon:"warning",showCancelButton:!0,confirmButtonColor:"red",cancelButtonColor:"green",confirmButtonText:"Yes, delete it!"}).then(b=>{b.isConfirmed&&$.ajax({url:"/deleteEmploi",method:"post",data:{id:a._id},success:function(a){"success"==a?(responsetxt="TimeTable Deleted successfully",Swal.fire({position:"center",icon:"success",title:responsetxt,showConfirmButton:!1,timer:1700}),$("#teachertimeTable").DataTable().ajax.reload(null,!1),teacherTimeTableDataTable.search("").draw()):Swal.fire({position:"top-center",icon:"error",title:"Error occured when deleting TimeTable!",showConfirmButton:!1,timer:1700})},error:function(a){Swal.fire({position:"top-center",icon:"error",title:a,showConfirmButton:!1,timer:1700})}})})},error:function(a){Swal.fire("Error","Error occured, please report this error!","error",{confirmButtonText:"Ok"})}})}),jQuery.extend(jQuery.fn.dataTableExt.oSort,{"extract-date-pre":function(a){return date=a.split("/"),Date.parse(date[1]+"/"+date[0]+"/"+date[2])},"extract-date-asc":function(a,b){return a<b?-1:a>b?1:0},"extract-date-desc":function(a,b){return a<b?1:a>b?-1:0}});var parcoursDataTable=$("#parcoursDatatable").DataTable({ajax:{url:`/teacherParcours/${coursNameTeacher}`,dataSrc:""},columns:[{data:"date",render:function(a){return a||""}},{data:"start_time",render:function(a){return a||""}},{data:"end_time",render:function(a){return a||""}},{data:"group_name",render:function(a){return a||""}},{data:"present",render:function(a){var b="";return a.forEach(a=>{b+=`<option class="presentMember" value="${a.email}">${a.name}</option>`}),presentOptions=`<select data-placeholder="Choose One" class="standartselect form-control" tabindex="1">${b}</select>`}},{data:"absent",render:function(a){var b="";return a.forEach(a=>{b+=`<option value="${a.email}">${a.name}</option>`}),absentOptions=`<select data-placeholder="" class="standartselect form-control" tabindex="1">${b}</select>`}},{defaultContent:"                                <div class='btn-group d-flex justify-content-center' role='group' aria-label='Basic mixed styles example'>                                    <button type='button'  class='btn px-2 btn-sm rounded mx-1 btn-warning btnUpdateParcours' data-toggle='modal' data-target='#UpdateparcoursModal' data-bs-whatever='@getbootstrap'><i class='fa fa-edit'></i></button>                                    <button type='button'  class='btn px-2 btn-sm rounded btn-danger btnDeleteParcours'><i class='fa fa-trash'></i></button>                                </div>                                "}],scrollX:!0,columnDefs:[{type:"extract-date",targets:0}]});function searchOnDatatableParcours(a,b){a.search(b).draw()}function clearParcoursForm(a){switch(a){case"add":$("#formAddPacours").trigger("reset"),$("#presentParcours").empty(),$("#cancelAddParcours").click();case"update":$("#formUpdatePacours").trigger("reset"),$("#presentParcoursUpdate").empty(),$("#cancelUpdateParcours").click()}}$("#addParcours").on("click",function(){$("#dateParcours").val("")}),$("#groupParcours").on("change",function(){var b=[],a=$("#groupParcours").val();$.ajax({url:"/presence",data:{gpe:a,cours:coursNameTeacher},method:"post",success:function(a){$("#presentParcours").empty(),a.forEach(a=>{b.push({mail:a.username,name:a.name}),$("#presentParcours").append(`<option value="${a.username}">${a.name}</option>`)})},error:function(a){Swal.fire("Error","Error has occured, please report this error!","error",{confirmButtonText:"Ok"})}})}),$("#resetAddParcourFrom").on("click",function(){$("#formAddPacours").trigger("reset"),$("#presentParcours").empty()}),$("#saveParcours").on("click",function(){var b=$("#dateParcours").val(),c=$("#timeStartParcours").val(),d=$("#timeEndParcours").val(),e=$("#groupParcours").val(),a=[],f=$("#presentParcours option:selected").toArray().map(a=>({username:a.value,name:a.text})),a=$("#presentParcours option:not(:selected)").toArray().map(a=>({username:a.value,name:a.text}));$.ajax({url:"/Teacheraddparcours",method:"post",data:{dateNewParcours:b,timestartAt:c,timeEndAt:d,cours:coursNameTeacher,groupParcoursName:e,present:f,absent:a},success:function(a){"exist"===a?Swal.fire("Error","this parcours already exist!","info",{confirmButtonText:"Ok"}):($("#parcoursDatatable").DataTable().ajax.reload(null,!1),Swal.fire("Parcours Saved","New parcours saved successfully!","success",{confirmButtonText:"Ok"}),clearParcoursForm("add"))},error:function(a){Swal.fire("Error",`${a}`,"error",{confirmButtonText:"Ok"})}})}),$(document).on("click",".btnUpdateParcours",function(){var a=$(this).closest("tr"),b=a.find("td:eq(0)").text(),c=a.find("td:eq(1)").text(),d=a.find("td:eq(2)").text(),e=a.find("td:eq(3)").text();parcoursUpdateData={cours:coursNameTeacher,date:b,heureStart:c,heureFin:d,groupe:e},$.ajax({url:"/getParcoursAjax",method:"post",data:parcoursUpdateData,dataType:"json",success:function(a){$("#presentParcoursUpdate").find("option").remove().end(),$("#groupUpdateParcours").val(a.groupe);var c=a.date;c=c.split("/").reverse().join("-"),$("#dateUpdateParcours").val(c),$("#timeStartUpdateParcours").val(a.timeStart),$("#timeEndUpdateParcours").val(a.timeEnd);for(let d=0;d<a.attendence.length;d++){var b=a.attendence[d];if(!0===b.presence){var e=`<option value="${b.id}" selected>${b.name}</option>`;$("#presentParcoursUpdate").append(e)}else{var e=`<option value="${b.id}">${b.name}</option>`;$("#presentParcoursUpdate").append(e)}}},error:function(a){Swal.fire({position:"top-center",icon:"error",title:a,showConfirmButton:!1,timer:1700})}})}),$("#saveUpdateParcours").on("click",function(){var d=$("#groupUpdateParcours").val(),e=$("#dateUpdateParcours").val(),f=$("#timeStartUpdateParcours").val(),g=$("#timeEndUpdateParcours").val(),h=$("#presentParcoursUpdate").val(),c=[];let a;var i=[];a=$("#presentParcoursUpdate option").toArray().map(a=>a.value);for(let b=0;b<a.length;b++)""!=a[b]&&c.push(a[b]);c.forEach(a=>{-1===h.indexOf(a)&&i.push(a)}),$.ajax({url:"/update_parcoursajax",method:"post",data:{dateNewParcours:e,timestartAt:f,timeEndAt:g,groupParcoursName:d,present:h,absent:i},success:function(a){$("#parcoursDatatable").DataTable().ajax.reload(null,!1),clearParcoursForm("update"),Swal.fire("Parcours Saved","Parcours updated successfully!","success",{confirmButtonText:"Ok"})},error:function(a){Swal.fire("Error","Error occured when perform this action!","error",{confirmButtonText:"Ok"})}})}),$(document).on("click",".btnDeleteParcours",function(){Swal.fire({title:"Delete Parcours",text:"Are you sure do delete this parcours?",icon:"warning",showCancelButton:!0,confirmButtonColor:"red",cancelButtonColor:"green",confirmButtonText:"Yes, delete it!"}).then(c=>{if(c.isConfirmed){var a=$(this).closest("tr"),b=a.find("td:eq(0)").text(),d=a.find("td:eq(1)").text(),e=a.find("td:eq(2)").text(),f=a.find("td:eq(3)").text();parcoursDeleteData={cours:coursNameTeacher,date:b=b.split("/").reverse().join("-"),heureStart:d,heureFin:e,groupe:f},$.ajax({url:"/deleteParcoursajax",method:"post",data:parcoursDeleteData,success:function(a){$("#parcoursDatatable").DataTable().ajax.reload(null,!1),responsetxt="Parcours deleted successfully!",Swal.fire({position:"center",icon:"success",title:responsetxt,showConfirmButton:!0})},error:function(a){Swal.fire({position:"top-center",icon:"error",title:a,showConfirmButton:!1,timer:1700})}})}})}),$("#cancelAddParcours").on("click",function(){$("#formAddPacours").trigger("reset"),$("#presentParcours").empty()})